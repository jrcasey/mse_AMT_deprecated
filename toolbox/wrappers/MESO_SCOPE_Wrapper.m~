%% MESO-SCOPE Simulation
% Runs and analyzes the MSE simulation for the MESO-SCOPE cruise.
%% set root dir
cd Documents/MATLAB/GitHub/mse/

%% Version
version = strcat({'_v'},datestr(date,'yyyymmdd'))

%% Version control and database paths
FileNames = struct;
% Current PanGEM
FileNames.PanGEM_Path = 'data/GEM/PanGEM.mat';
% Organism database
FileNames.orgDB_Path = 'data/db/orgDatabase.csv';
% Current strain models
FileNames.StrMod_Path = 'data/GEM/targStrMod3.mat';
% List of strains to be analyzed
FileNames.strainList_Path = 'data/db/strainList.mat';
% Current OGTDat
FileNames.OGTDat_Path = 'data/db/OGTDat.csv';
% Cruise data
FileNames.CruiseDB_filename = 'data/envData/MESO-SCOPE.csv';
% HyperPro profiles
FileNames.IrrDat_fileName = 'data/envData/IrrDat.mat';
% TpDat path
FileNames.TpDat_fileName = 'data/db/TpDat.csv';
% PhysOpt and PigOpt constraints path
FileNames.PhysOptPigOptConstraints_fileName = 'data/db/BOFConstraints.csv';
% PigDB path
FileNames.PigDB_fileName = 'data/db/AbsorptionDatabase.csv';
% Destination for solution
FileNames.destination_fileName = strcat('data/output/FullSolution',version,'.mat');

%% Gridding
Gridding = struct;
% Stations
Gridding.stationsVec = 4:15;
Gridding.nStations = numel(Gridding.stationsVec);
% Depth (m)
Gridding.minZ = 15;
Gridding.maxZ = 181;
Gridding.intervalZ = 10;
Gridding.depthVec = Gridding.minZ:Gridding.intervalZ:Gridding.maxZ;
Gridding.nZ = numel(Gridding.depthVec);
% Wavelength (nm)
Gridding.minLambda = 300; % nm
Gridding.maxLambda = 850; %nm
Gridding.bandwidth = 2; % nm
Gridding.lambdaVec = Gridding.minLambda:Gridding.bandwidth:Gridding.maxLambda; % nm wavelength

%% Options
Options = struct;
% Set options
Options.saveSolution = false;
Options.saveStrMod = false;
Options.maxIter_TpOpt = 1000;
Options.maxIter_physOpt = 1000;
%Options.saveCruiseData = true;

%% Get strains to analyze
load strainList
strNameVec = strList;
nStr = numel(strNameVec);

%% Find index from SLURM
% preallocate a 3d matrix of dimensions nStations, nZ, nStr
idxMat = zeros(Gridding.nStations,Gridding.nZ,nStr);
nIterations = size(idxMat,1).*size(idxMat,2).*size(idxMat,3);
% get job array index
job_array_idx = getenv('SLURM_ARRAY_TASK_ID');
% locate coordinates
[i,j,k] = ind2sub(size(idxMat),job_array_idx);

%% Run simulation


station = Gridding.stationsVec(i);
depth = Gridding.depthVec(j);
strName = strNameVec{k};

%Solution = struct;
tic;
[Solution] = MESO_SCOPE_Simulation(strName, station, depth, Gridding, FileNames, Options);
dt = toc;
Solution.runtime = dt;

if ~Options.saveStrMod
    Solution.StrMod = [];
end

%% Save solution
%save(cell2str(FileNames.destination_fileName),'FullSolution');


